/*
| ------------------------------------------------------------------------------
| Datagrid
| ------------------------------------------------------------------------------
| datagrid();
| ------------------------------------------------------------------------------
*/
var icon = {
    "success": '<i class="fas fa-check-circle fa-lg text-success"></i>',
    "info": '<i class="fas fa-info-circle fa-lg text-info"></i>',
    "warning": '<i class="fa fa-exclamation-triangle fa-lg text-warning"></i>',
    "danger": '<i class="fas fa-times-circle fa-lg text-danger"></i>',
    "close": '<i class="fa fa-times-circle"></i>',
    "plus": '<i class="fa fa-plus"></i>',
    "edit": '<i class="fa fa-edit"></i>',
    "trash": '<i class="fa fa-trash"></i>',
    "check": '<i class="fa fa-check"></i>',
    "search": '<i class="fa fa-search"></i>',
    "square": '<i class="fas fa-square"></i>',
    "check_square": '<i class="fas fa-check-square"></i>'
};
var record = null;
function tabulator(columns, attr) {
    record = function (action) {
        action = action.id;
        if (action === "add") {
            ajax(attr["action"]);
        } else if (action === "delete" || action === "edit") {
            var data = table.getSelectedData();
            var size = data.length;
            if (action === "edit" && size === 1) {
                ajax(attr["add"], function () {
                    $("form").each(function (n) {
                        if (n === 0) { // First form found.
                            $(this).prepend('<input type="hidden" name="id">');
                            for( var key in data[0] ) {
                                $(this).find('input[name="' + key + '"]').val(data[0][key]);
                            }
                        }
                    });
                });
            } else if (action === "delete" && size > 0) {
                bootbox.confirm({
                    centerVertical: true,
                    closeButton: false,
                    message: icon["warning"] + " " + i18n("Do you want to delete the selected records?"),
                    buttons: {
                        cancel: {
                            label: icon["close"] + " " + i18n("Cancel"),
                            className: "btn-danger"
                        },
                        confirm: {
                            label: icon["check"] + " " + i18n("Confirm"),
                            className: "btn-success"
                        }
                    },
                    callback: function (event) {
                        if (event) {
                            var id = [];
                            var n  = 0;
                            for (var i=0; i < size; i++) {
                                if (data[i].id) {
                                    id[n] = data[i].id;
                                    n++;
                                }
                            }
                            ajax(attr["action"] + "/delete/" + id, function (res) {
                                table.deselectRow();
                                $("#action > #delete").attr("disabled", true);
                                $("#action > #edit").attr("disabled", true);
                                if (res.data && res.result) {
                                    table.deleteRow(id);
                                    data = icon["success"] + " " + i18n("Successfully deleted!");
                                } else {
                                    data = icon["danger"] + " " + i18n("Error! Could not delete!");
                                }
                                bootbox.alert({
                                    centerVertical: true,
                                    closeButton: false,
                                    message: data,
                                    buttons: {
                                        ok: {
                                            label: icon["close"] + " " + i18n("Close"),
                                            className: "btn-secondary"
                                        }
                                    }
                                });
                            });
                        }
                    }
                });
            }
        }
    };
    var table = new Tabulator("#" + attr["id"], {
        tableBuilding: function () {
            $('<div class="container-fluid">\
                <div class="row bg-light" style="border: 1px solid #999; border-bottom: 0">\
                  <div id="action" class="col-7">\
                    <button id="add" class="btn btn-secondary btn-sm my-2 my-sm-2 ms-1" onclick="record(this)">' + icon["plus"] + ' ' + i18n("Add") + '</button>\
                    <button id="edit" class="btn btn-secondary btn-sm my-2 my-sm-2 ms-1" disabled onclick="record(this)">' + icon["edit"] + ' ' + i18n("Edit") + '</button>\
                    <button id="delete" class="btn btn-secondary btn-sm my-2 my-sm-2 ms-1" disabled onclick="record(this)">' + icon["trash"] + ' ' + i18n("Delete") + '</button>\
                  </div>\
                  <div class="col-1">\
                  </div>\
                  <div class="col-4">\
                    <form action="' + attr["action"] + '/select" class="d-flex my-2 my-lg-1 ajax">\
                      <input class="form-control ms-sm-2" type="search" placeholder="' + i18n("Search") + '" aria-label="Search" maxlength="250">\
                      <button type="submit" class="btn btn-primary my-2 my-sm-0">' + icon["search"] + '</button>\
                    </form>\
                  </div>\
                </div>\
              </div>').insertBefore("#" + attr["id"]);
        },
        ajaxURL: attr["action"] + "/select",
        ajaxRequestFunc: false,
        ajaxConfig: {
        method: "get",
            headers: {
                "Content-type": "application/json; charset=utf-8"
            }
        },
/*ajaxResponse: function (url, params, response) {
return response;
},*/
        locale: false,
        langs: {
            "default": {
                "ajax": {
                    "loading": i18n("Loading..."),
                    "error": i18n("Error")
                },
                "groups": {
                    "item": i18n("Item"),
                    "items": i18n("Items")
                },
                "pagination": {
                    "page_size": i18n("Page size"),
                    "first": i18n("First"),
                    "first_title": i18n("First page"),
                    "last": i18n("Last"),
                    "last_title": i18n("Last page"),
                    "prev": i18n("Previous"),
                    "prev_title": i18n("Previous page"),
                    "next": i18n("Next"),
                    "next_title": i18n("Next page")
                },
                "headerFilters": {
                    "default": i18n("Filter column"),
                    "columns": {
                        "name": i18n("Filter name")
                    }
                }
            }
        },
        height: attr["height"],
        layout: "fitColumns",
        responsiveLayout: "hide",
        tooltips: true,
        history: true,
        pagination: "local",
        paginationSize: 10,
        movableColumns: true,
        resizableRows: false,
        selectable: true,
        columns: columns,
        rowContextMenu: function (component) {
            component.select();
            var data = table.getSelectedData();
            var flag = true;
            if (data.length === 1) {
                flag = false;
            }
            var menu = [{
                    // ---------------------------------------------------------
                    // Select all
                    // ---------------------------------------------------------
                    label: icon["check_square"] + " " + i18n("Select all"),
                    action: function (e, row) {
                        table.selectRow();
                    }
                },{ // ---------------------------------------------------------
                    // Remove selection
                    // ---------------------------------------------------------
                    label: icon["square"] + " " + i18n("Remove selection"),
                    action: function (e, row) {
                        table.deselectRow();
                    }
                },{ // =========================================================
                    separator: true
                },{ // ---------------------------------------------------------
                    // Edit
                    // ---------------------------------------------------------
                    label: icon["edit"] + " " + i18n("Edit"),
                    disabled: flag,
                    action: function (e, row) {
                        record({id:"edit"});
                    }
                },{ // ---------------------------------------------------------
                    // Delete
                    // ---------------------------------------------------------
                    label: icon["trash"] + " " + i18n("Delete"),
                    action: function (e, row) {
                        record({id:"delete"});
                    }
                }];
            return menu;
        },
        rowSelectionChanged: function (data, rows) {
            if (data.length === 1) {
                $("#action > #edit").attr("disabled", false);
            } else {
                $("#action > #edit").attr("disabled", true);
            }
            if (data.length > 0) {
                $("#action > #delete").attr("disabled", false);
            } else {
                $("#action > #delete").attr("disabled", true);
            }
        }
    });
    return table;
}

function datagrid() {
    $("datagrid").each(function (n) {
        var columns = [];
        var attr    = [];
        if (!$(this).attr("id")) {
            $(this).attr("id", "dg_" + n);
        }
        $("#" + $(this).attr("id") + ">column").each(function (i) {
            columns[i]          = [];
            columns[i]["title"] = $(this).html();
            columns[i]["field"] = $(this).attr("name");
            if ($(this).attr("width")) {
                columns[i]["width"] = $(this).attr("width");
            }
            if ($(this).attr("align")) {
                columns[i]["hozAlign"] = $(this).attr("align");
            }
        });
        attr["id"]     = $(this).attr("id");
        attr["action"] = $(this).attr("action");
        attr["height"] = $(this).attr("height") || "auto";
        tabulator(columns, attr);
    });
}
